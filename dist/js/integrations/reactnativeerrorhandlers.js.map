{"version":3,"file":"reactnativeerrorhandlers.js","sourceRoot":"","sources":["../../../src/js/integrations/reactnativeerrorhandlers.ts"],"names":[],"mappings":"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","sourcesContent":["import { getCurrentHub } from \"@sentry/core\";\nimport { Integration, Severity } from \"@sentry/types\";\nimport { logger } from \"@sentry/utils\";\n\nimport { ReactNativeClient } from \"../client\";\n\n/** ReactNativeErrorHandlers Options */\ninterface ReactNativeErrorHandlersOptions {\n  onerror: boolean;\n  onunhandledrejection: boolean;\n}\n\ndeclare const global: any;\n\n/** ReactNativeErrorHandlers Integration */\nexport class ReactNativeErrorHandlers implements Integration {\n  /**\n   * @inheritDoc\n   */\n  public name: string = ReactNativeErrorHandlers.id;\n\n  /**\n   * @inheritDoc\n   */\n  public static id: string = \"ReactNativeErrorHandlers\";\n\n  /** ReactNativeOptions */\n  private readonly _options: ReactNativeErrorHandlersOptions;\n\n  /** Constructor */\n  public constructor(options?: ReactNativeErrorHandlersOptions) {\n    this._options = {\n      onerror: true,\n      onunhandledrejection: true,\n      ...options\n    };\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public setupOnce(): void {\n    this._handleUnhandledRejections();\n    this._handleOnError();\n  }\n\n  // tslint:disable: no-unsafe-any\n\n  /**\n   * Handle Promises\n   */\n  private _handleUnhandledRejections(): void {\n    if (this._options.onunhandledrejection) {\n      // tslint:disable-next-line: no-implicit-dependencies\n      const tracking = require(\"promise/setimmediate/rejection-tracking\");\n      tracking.disable();\n      tracking.enable({\n        allRejections: true,\n        onHandled: () => {\n          // We do nothing\n        },\n        onUnhandled: (id: any, error: any) => {\n          if (__DEV__) {\n            console.warn(id, error);\n          }\n          getCurrentHub().captureException(error, {\n            data: { id },\n            originalException: error\n          });\n        }\n      });\n    }\n  }\n\n  /**\n   * Handle erros\n   */\n  private _handleOnError(): void {\n    if (this._options.onerror) {\n      let handlingFatal = false;\n\n      const defaultHandler =\n        ErrorUtils.getGlobalHandler && ErrorUtils.getGlobalHandler();\n\n      ErrorUtils.setGlobalHandler((error: any, isFatal?: boolean) => {\n        // We want to handle fatals, but only in production mode.\n        const shouldHandleFatal = isFatal && !global.__DEV__;\n        if (shouldHandleFatal) {\n          if (handlingFatal) {\n            logger.log(\n              \"Encountered multiple fatals in a row. The latest:\",\n              error\n            );\n            return;\n          }\n          handlingFatal = true;\n        }\n\n        getCurrentHub().withScope(scope => {\n          if (isFatal) {\n            scope.setLevel(Severity.Fatal);\n          }\n          getCurrentHub().captureException(error, {\n            originalException: error\n          });\n        });\n\n        const client = getCurrentHub().getClient<ReactNativeClient>();\n        // If in dev, we call the default handler anyway and hope the error will be sent\n        // Just for a better dev experience\n        if (client && !__DEV__) {\n          client.flush(client.getOptions().shutdownTimeout || 2000).then(() => {\n            defaultHandler(error, isFatal);\n          });\n        } else {\n          // If there is no client something is fishy, anyway we call the default handler\n          defaultHandler(error, isFatal);\n        }\n      });\n    }\n  }\n\n  // tslint:enable: no-unsafe-any\n}\n"]}